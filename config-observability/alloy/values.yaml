alloy:
  controller:
    # -- Type of controller to use for deploying Grafana Alloy in the cluster.
    # Must be one of 'daemonset', 'deployment', or 'statefulset'.
    type: 'statefulset'
  alloy:
    clustering:
      enabled: false
    configMap:
      content: |-
        // Write your Alloy config here:
        logging {
          level  = "info"
          format = "logfmt"
        }

        // 1. Find the nodes
        discovery.kubernetes "nodes" {
          role = "node"
        }

        // 2. Point to the Kubelet's cAdvisor endpoint
        prometheus.scrape "cadvisor" {
          targets = discovery.kubernetes.nodes.targets

          // This tells Alloy to look at the /metrics/cadvisor path
          metrics_path = "/metrics/cadvisor"
          scheme       = "https"

          // Use the standard K8s credentials provided to the Alloy pod
          authorization {
            type = "Bearer"
            credentials_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          }

          tls_config {
            ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
            insecure_skip_verify = true // Required for Minikube's self-signed certs
          }

          forward_to = [prometheus.remote_write.mimir_receiver.receiver]
        }

        // 3. Point to the Kubelet's main metrics endpoint
        prometheus.scrape "kubelet" {
          targets = discovery.kubernetes.nodes.targets
          
          // NOTE: We do NOT use /metrics/cadvisor here
          metrics_path = "/metrics" 
          scheme       = "https"

          authorization {
            type = "Bearer"
            credentials_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          }

          tls_config {
            ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
            insecure_skip_verify = true 
          }

          forward_to = [prometheus.remote_write.mimir_receiver.receiver]
        }

        // Scrape Node Exporter
        discovery.kubernetes "node_exporter" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=prometheus-node-exporter"
          }
        }

        prometheus.scrape "node_exporter" {
          targets    = discovery.kubernetes.node_exporter.targets
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          scrape_interval = "30s"
          scrape_timeout  = "10s"
        }

        // Scrape Kube-State-Metrics
        discovery.kubernetes "ksm" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=kube-state-metrics"
          }
        }

        prometheus.scrape "kube_state_metrics" {
          targets    = discovery.kubernetes.ksm.targets
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          scrape_interval = "30s"
          scrape_timeout  = "10s"
        }

        // 4. Remote write to Mimir
        prometheus.remote_write "mimir_receiver" {
          endpoint {
            url = "http://mimir-gateway.observability.svc.cluster.local/api/v1/push"
            send_native_histograms = true
          }
        }

