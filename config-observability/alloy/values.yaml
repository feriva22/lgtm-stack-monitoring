alloy:
  controller:
    # -- Type of controller to use for deploying Grafana Alloy in the cluster.
    # Must be one of 'daemonset', 'deployment', or 'statefulset'.
    type: 'daemonset'
  alloy:
    clustering:
      enabled: false
    configMap:
      content: |-
        // Write your Alloy config here:
        logging {
          level  = "info"
          format = "logfmt"
        }

        // Scrape Node Exporter
        discovery.kubernetes "node_exporter" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=prometheus-node-exporter"
          }
        }

        prometheus.scrape "node_exporter" {
          targets    = discovery.kubernetes.node_exporter.targets
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          scrape_interval = "30s"
          scrape_timeout  = "10s"
        }

        // Scrape Kube-State-Metrics
        discovery.kubernetes "ksm" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=kube-state-metrics"
          }
        }

        prometheus.scrape "kube_state_metrics" {
          targets    = discovery.kubernetes.ksm.targets
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          scrape_interval = "30s"
          scrape_timeout  = "10s"
        }

        // 4. Remote write to Mimir
        prometheus.remote_write "mimir_receiver" {
          endpoint {
            url = "http://mimir-gateway.observability.svc.cluster.local/api/v1/push"
            send_native_histograms = true
          }
        }

