alloy:
  controller:
    # -- Type of controller to use for deploying Grafana Alloy in the cluster.
    # Must be one of 'daemonset', 'deployment', or 'statefulset'.
    type: 'statefulset'
  alloy:
    clustering:
      enabled: false
    configMap:
      content: |-
        logging {
          level  = "info"
          format = "logfmt"
        }

        // ==========================================================
        // 1. DISCOVERY SECTION
        // ==========================================================

        // Discover Nodes for Kubelet & cAdvisor
        discovery.kubernetes "nodes" {
          role = "node"
        }

        // Discover Node Exporter Service
        discovery.kubernetes "node_exporter" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=prometheus-node-exporter"
          }
        }

        // Discover Kube-State-Metrics Service
        discovery.kubernetes "ksm" {
          role = "service"
          selectors {
            role = "service"
            label = "app.kubernetes.io/name=kube-state-metrics"
          }
        }

        // ==========================================================
        // 2. RELABELING SECTION (Dashboard Compatibility Fixes)
        // ==========================================================

        // Fix for cAdvisor: Requires job="kubelet" AND metrics_path="/metrics/cadvisor"
        prometheus.relabel "cadvisor_fix" {
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          rule {
            target_label = "job"
            replacement  = "kubelet"
          }

          rule {
            target_label = "metrics_path"
            replacement  = "/metrics/cadvisor"
          }

          rule {
            target_label = "cluster"
            replacement  = "cloud-a-cluster-1" // Change this value as needed
          }
          
        }

        // Fix for Node Exporter: Requires job="node-exporter"
        prometheus.relabel "node_exporter_fix" {
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          rule {
            target_label = "job"
            replacement  = "node-exporter"
          }

          rule {
            target_label = "cluster"
            replacement  = "cloud-a-cluster-1" // Change this value as needed
          }
        }

        // Fix for KSM: Requires job="kube-state-metrics"
        prometheus.relabel "ksm_fix" {
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          rule {
            target_label = "job"
            replacement  = "kube-state-metrics"
          }

          // Optional: Add cluster label if your dashboard uses $cluster variable
          rule {
            target_label = "cluster"
            replacement  = "cloud-a-cluster-1" // Change this value as needed
          }
        }

        // Fix for Kubelet (Summary/Main): Requires job="kubelet"
        prometheus.relabel "kubelet_fix" {
          forward_to = [prometheus.remote_write.mimir_receiver.receiver]

          rule {
            target_label = "job"
            replacement  = "kubelet"
          }

          rule {
            target_label = "metrics_path"
            replacement  = "/metrics"
          }

          rule {
            target_label = "cluster"
            replacement  = "cloud-a-cluster-1" // Change this value as needed
          }
        }

        // ==========================================================
        // 3. SCRAPE SECTION
        // ==========================================================

        prometheus.scrape "cadvisor" {
          targets      = discovery.kubernetes.nodes.targets
          metrics_path = "/metrics/cadvisor"
          scheme       = "https"

          authorization {
            type = "Bearer"
            credentials_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          }

          tls_config {
            ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
            insecure_skip_verify = true 
          }

          forward_to = [prometheus.relabel.cadvisor_fix.receiver]
        }

        prometheus.scrape "kubelet" {
          targets      = discovery.kubernetes.nodes.targets
          metrics_path = "/metrics" 
          scheme       = "https"

          authorization {
            type = "Bearer"
            credentials_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
          }

          tls_config {
            ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
            insecure_skip_verify = true 
          }

          forward_to = [prometheus.relabel.kubelet_fix.receiver]
        }

        prometheus.scrape "node_exporter" {
          targets    = discovery.kubernetes.node_exporter.targets
          forward_to = [prometheus.relabel.node_exporter_fix.receiver]
        }

        prometheus.scrape "kube_state_metrics" {
          targets    = discovery.kubernetes.ksm.targets
          forward_to = [prometheus.relabel.ksm_fix.receiver]
        }

        // ==========================================================
        // 4. REMOTE WRITE SECTION
        // ==========================================================

        prometheus.remote_write "mimir_receiver" {
          endpoint {
            url = "http://mimir-gateway.observability.svc.cluster.local/api/v1/push"
            send_native_histograms = true
          }
        }